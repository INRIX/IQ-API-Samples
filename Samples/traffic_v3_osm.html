<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Traffic View</title>

    <script src="../Core/Dependencies/jquery.js"></script>
    <script src="../Core/Dependencies/jquery.pubsub.js"></script>

    <link rel="stylesheet" href="External/leaflet/leaflet.css"/>

    <script src="External/leaflet/leaflet.js"></script>

</head>
<body>
    <div id="map" style="left:0px;top:0px;width:100%;height:100%;position:absolute;display:inline;"></div>
    <script>
        (function() {
            $.support.cors = true; //need CORS support for IE

            // Init Leaflet Maps with the location (hardcoded below to San Francisco) and appropriate zoom level
            var map = new L.Map('map', {
                center: new L.LatLng(37.7746, -122.4178),
                zoom: 13
            });

            // Create OSM Tile Layer.
            var osm = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
            map.addLayer(osm);
            
            debugger;
            // Setup INRIX map and traffic tile layers
            //var inrixMap = new L.TileLayer("", { maxZoom: 16, attribution: false });
            var trafficLayer = new L.TileLayer("", { maxZoom: 16, attribution: false });

            var tilesAPIUrl = "https://api.iq.inrix.systems/v1/tiles/"; //"https://tile-api.inrix.com/v1/tiles/"; 
			//Simple function to create an INRIX tile call at a specific point and zoom level
			this.trafficTileUrlFromTileXY = function(tilePoint, zoom) {
				
                var quadKey = this.tileXYToQuadKey(tilePoint.x, tilePoint.y, zoom);
                //var url = tilesAPIUrl + quadKey +"?accessToken="+this.accessToken+"&coverage=255&speedBucketId=54135&penWidth=16&opacity=80&roadsegmenttype=XDS";
				var url = tilesAPIUrl + quadKey +"?accessToken="+this.accessToken+"&opacity=80&penWidth=3";
				return url;
			
			}
			//UAS token management would be handled on the backend of your server, it would get / renew / reuse the token as necessary
			this.accessToken = "Your API Token";
			
			//Convert a point and zoom to quad key
			this.tileXYToQuadKey = function(x, y, zoom) {
				var key = [], quadKey, i, keyVal, mask;

				for(i = zoom; i > 0; i--) {
					keyVal = '0';
					mask = 1 << (i-1);
					if( (x & mask) !== 0)
					{
						keyVal++;
					}
					if( (y & mask) !== 0)
					{
						keyVal++;
						keyVal++;
					}
					key.push(keyVal);
				}
				quadKey = key.join("");
				return quadKey;
			};
			
            // Fetch the  Traffic Tile layer from the server, this is called any time a tile is needed
            trafficLayer.getTileUrl = function (tilePoint, zoom) {
                zoom || (zoom = map.getZoom());
                return trafficTileUrlFromTileXY(tilePoint, zoom);
            };

            // Disable traffic layer at a zoomed out layer of the continent. Add the traffic layer to the map.
            trafficLayer.options.minZoom = 5;
            map.addLayer(trafficLayer);
        }());

    </script>
</body>
</html>
