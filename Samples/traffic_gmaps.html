<!DOCTYPE html>
<html>

<head>
    <title>Inrix Traffic on Google Maps</title>

    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0;
            padding: 0
        }

        #map_canvas {
            height: 100%
        }
    </style>
    <script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>

    <script src="../Core/Dependencies/jquery.js"></script>
    <script src="../Core/Dependencies/jquery.pubsub.js"></script>

    <script src="../Core/inrix.3.0.js"></script>
    <script src="../Core/inrix.sample.layer.js"></script>

</head>

<body>
    <div id="map_canvas" style="width:100%;height:100%"></div>

    <script>

        // helper function to fetch token from an API backend
        async function getToken() {
            const axiosConfig = {
                headers: {
                    "content-type": "application/json",
                    "Accept": "application/json"
                }
            }

            const tokenRes = await axios
                .get(config.inrixTokenAPI,
                    axiosConfig)
                .then(response => {
                    // if (response.status === 200) {
                    this.accessToken = response.data;
                    return response.data;
                    // }
                })
                .catch(error => {
                    console.error(error)
                })
            return tokenRes;
        }


        (async function () {
            //  $.support.cors = true; //need CORS support for IE
            // UAS token management would be handled on the backend of your server, it would get / renew / reuse the token as necessary

            // setting up bounds
            const southWest = L.latLng(37.718455, -122.350874),
                northEast = L.latLng(37.810963, -122.535406);
            const bounds = L.latLngBounds(southWest, northEast);

            // Init Leaflet Maps with the location (hardcoded below to San Francisco) and appropriate zoom level
            const map = new L.Map('map', {
                zoom: 15,
                center: bounds.getCenter(),
                maxBounds: bounds,
                maxBoundsViscosity: 1,
            });


            let expiredToken = true;

            // check localStorage for token
            if (localStorage.token) {
                this.accessToken = JSON.parse(localStorage.getItem('token'));
                // check if token expiry is ok      
                expiry_date = this.accessToken.exp;
                if (expiry_date > new Date().getTime() / 1000) { // miliseconds comparison
                    // not expired token
                    expiredToken = false;
                }
            }
            // if expired get new token and place it in localStorage
            if (expiredToken) {
                // make call to tokenAPI and set the token
                // getting the accessToken from the API asynchronously
                console.log('fetching request for new token');
                this.accessToken = await getToken();
                if (this.accessToken) { localStorage.setItem('token', JSON.stringify(this.accessToken)); }
                expiredToken = false;
            }

            // regenerate token little before (5sec.) expiry time
            const bufferTime = 10000; // 5 sec. before the token expiry_time.
            let now = new Date().getTime();
            let exp_date = new Date(this.accessToken.exp * 1000 - bufferTime).getTime();
            this.refreshIn = Math.round(exp_date - now); // in miliseconds
            if (this.refreshIn > 0) {
                setInterval(async () => {
                    await calculateRefresh();
                    console.log('regenerating token in: ', Math.round(this.refreshIn / 1000) + 'sec.');
                }, this.refreshIn);
            }

            // make function to recheck with the next token expiry time
            this.calculateRefresh = async () => {
                this.accessToken = await getToken();
            }



            console.log();

        // Setup Google Maps layer
        var center = new google.maps.LatLng(37.7746, -122.4178);
        var mapOptions = {
            center: center,
            zoom: 13,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
        //Note: You will need to write a mechanisim for managing the token (Renew when Expired, get token on init, etc)
        var traffic = new InrixTileLayer(map, "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkZXZpY2VJZCI6IjAwMDAwMDAwLTAwMDAtMDAwMC0wMDAwLTAwMDAwMDAwMDAwMCIsImNzVG9rZW4iOm51bGwsInVzZXJSb2xlIjoxLCJhcHBSb2xlIjoxLCJ1c2VySWQiOiI2Y2I1ZDZkMy02YmIwLTRlMGYtODE3MC0wMzVkYWUxMzkwOWEiLCJhcHBJZCI6ImFiOGViYWQwLTQ3MGQtNDY5Zi05ODI1LWQ1YjgxNmVlZWU1YSIsImRldmVsb3BlcklkIjoiYTk0ODRiZGEtY2MxZC00YTdiLTgzMGQtYjJhNDZiYjgwY2Y3IiwiZXhwaXJ5IjoiMjAyMS0wNi0xMVQyMDo1OTozNS4wOTkwMzI1WiIsImV4cCI6MTYyMzQ0NTE3NSwicm9sZSI6InVzZXIifQ.n_iaQ9pScYVdnla2LRBc9g4bZC8BEcW1W1Z-7FpGhOE");
        traffic.show();


           
}());


 // console.log('recalculate refresh time');
                // console.log('got info:', this.accessToken.exp *1000);
                // let bufferTime = 5000; // 5 sec before token_time.
                // let now = new Date().getTime();
                // console.log('now is:', new Date());
                // let exp_date = new Date(this.accessToken.exp * 1000 - bufferTime).getTime();
                // console.log('server expiry date: ',new Date(this.accessToken.exp *1000));
                // console.log('token expity date:', new Date(this.accessToken.exp * 1000 - bufferTime));
                // console.log('token exp_date is:', exp_date);
                // this.refreshIn = Math.round(exp_date - now); // in miliseconds
                // console.log('calculated refresh: ', this.refreshIn);




    </script>
</body>

</html>