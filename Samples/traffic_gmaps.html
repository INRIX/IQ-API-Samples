<!DOCTYPE html>
<html>

<head>
    <title>Inrix Traffic on Google Maps</title>

    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0;
            padding: 0
        }

        #map_canvas {
            height: 100%
        }
    </style>
    <script src="http://maps.google.com/maps/api/js?v=weekly"></script>

    <!-- <script async
    src="https://maps.googleapis.com/maps/api/js?v=weekly
        &key=YOUR_API_KEY&callback=initMap">
</script> -->

    <!-- <script src="../Core/Dependencies/jquery.js"></script>
    <script src="../Core/Dependencies/jquery.pubsub.js"></script> -->

    <!-- <script src="../Core/inrix.3.0.js"></script> -->
    <script src="../Core/inrix.sample.layer.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script type="text/javascript" src="client-config.js"></script>

</head>

<body>
    <div id="map_canvas" style="width:100%;height:100%"></div>

    <script>

        // helper function to fetch token from an API backend
        async function getToken() {
            const axiosConfig = {
                headers: {
                    "content-type": "application/json",
                    "Accept": "application/json"
                }
            }

            const tokenRes = await axios
                .get(config.inrixTokenAPI,
                    axiosConfig)
                .then(response => {
                    // if (response.status === 200) {
                    this.accessToken = response.data;
                    return response.data;
                    // }
                })
                .catch(error => {
                    console.error(error)
                })
            return tokenRes;
        }


        (async function () {
            //  $.support.cors = true; //need CORS support for IE
            // UAS token management would be handled on the backend of your server, it would get / renew / reuse the token as necessary

            let expiredToken = true;

            // check localStorage for token
            if (localStorage.token) {
                this.accessToken = JSON.parse(localStorage.getItem('token'));
                // check if token expiry is ok      
                expiry_date = this.accessToken.exp;
                if (expiry_date > new Date().getTime() / 1000) { // miliseconds comparison
                    // not expired token
                    expiredToken = false;
                }
            }
            // if expired get new token and place it in localStorage
            if (expiredToken) {
                // make call to tokenAPI and set the token
                // getting the accessToken from the API asynchronously
                console.log('fetching request for new token');
                this.accessToken = await getToken();
                if (this.accessToken) { localStorage.setItem('token', JSON.stringify(this.accessToken)); }
                expiredToken = false;
            }

            // regenerate token little before (5sec.) expiry time
            const bufferTime = 10000; // 5 sec. before the token expiry_time.
            let now = new Date().getTime();
            let exp_date = new Date(this.accessToken.exp * 1000 - bufferTime).getTime();
            this.refreshIn = Math.round(exp_date - now); // in miliseconds
            if (this.refreshIn > 0) {
                setInterval(async () => {
                    await calculateRefresh();
                    console.log('regenerating token in: ', Math.round(this.refreshIn / 1000) + 'sec.');
                }, this.refreshIn);
            }

            // make function to recheck with the next token expiry time
            this.calculateRefresh = async () => {
                this.accessToken = await getToken();
            }

            // Setup Google Maps layer
            const SF_BOUNDS = {
                north: -122.75,
                south: 37.7,
                west: -122.75,
                east: 37.8,
            };

            const SF = { lat: 37.7746, lng: -122.4178 };

            var center = new google.maps.LatLng(SF);
            var mapOptions = {
                center: center,
                zoom: 15,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                restriction: {
                    latLngBounds: SF_BOUNDS,
                    strictBounds: true,
                },

            };
            var map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
            var traffic = new InrixTileLayer(map, this.accessToken.token, config);
            traffic.show();

        }());

    </script>
</body>

</html>