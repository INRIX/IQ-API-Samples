<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>INRIX Incidents</title>
    <link
      href="http://fonts.googleapis.com/css?family=Lato:400,700"
      rel="stylesheet"
      type="text/css"
    />

    <link rel="stylesheet" type="text/css" href="../css/shared-styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script type="text/javascript" src="../client-config.js"></script>
    <!-- <script src="https://cdn.rawgit.com/vkiryukhin/vkBeautify/master/vkbeautify.js"></script> -->
    <script type="text/javascript" src="../util/token.js"></script>
  </head>

  <body>
    <h2 class="title">Incidents with Google Map</h2>
    <div class="description">
      Sample description text here. Sample description text here. Sample
      description text here. Sample description text here. Sample description
      text here. Sample description text here. Sample description text here.
      Sample description text here. Sample description text here. Sample
      description text here. Sample description text here. Sample description
      text here. Sample description text here. Sample description text here.
    </div>
    <div class="row">
      <!-- Structure of the options panel on the left -->
      <div class="options-panel">
        <div class="options">
          <div class="option-header">Box</div>
          <input
            type="text"
            id="box"
            name="box"
            placeholder="37.757386|-122.490667,37.746138|-122.395481"
          />

          <div class="options">
            <h4>Radius (meters)</h4>
            <ul class="items">
              <li><input type="checkbox" name="radius" value="10" />10</li>
              <li><input type="checkbox" name="radius" value="15" />15</li>
              <li>
                <input type="checkbox" name="radius" value="150" checked />150
              </li>
            </ul>
          </div>

          <div class="options">
            <h4>Incident type</h4>
            <ul class="items">
              <li>
                <input
                  type="checkbox"
                  name="incidentType"
                  value="Incidents"
                />Incidents
              </li>
              <li>
                <input
                  type="checkbox"
                  name="incidentType"
                  value="Construction"
                />Construction
              </li>

              <li>
                <input
                  type="checkbox"
                  name="incidentType"
                  value="Events"
                />Events
              </li>

              <li>
                <input
                  type="checkbox"
                  name="incidentType"
                  value="Flow"
                  checked
                />Flow
              </li>
            </ul>
          </div>
        </div>
        <div class="options center">
          <input
            type="button"
            onclick="drawIncidents()"
            value="Show"
            class="btn"
          /><br />
        </div>
        <div id="loading-panel" class="center" style="display: none">
          <h4>Getting results...</h4>
        </div>
      </div>

      <div class="map-panel">
        <div id="map"></div>
      </div>
    </div>
  </body>

  <script>
    //Global variables
    const SF = { lat: 37.764832, lng: -122.443079 };
    var map,
      marker = null;
    async function initMap() {
      // setting up San Francisco boundaries:
      const strictBounds = new google.maps.LatLngBounds(
        new google.maps.LatLng(37.718455, -122.535406),
        new google.maps.LatLng(37.810963, -122.350874)
      );

      const center = new google.maps.LatLng(SF);

      const myOptions = {
        zoom: 14,
        center: center,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
      };
      map = new google.maps.Map(document.getElementById("map"), myOptions);

      new google.maps.Marker({
        position: center,
        map,
        title: "San Francisco Center Marker",
      });
    }

    async function readCheckboxValues(checkedCheckboxArray) {
      var result = "";
      for (var i = 0, n = checkedCheckboxArray.length; i < n; i++) {
        result += "," + checkedCheckboxArray[i].value;
      }

      if (result) {
        result = result.substring(1);
      }

      return result;
    }

    async function getIncidentsData(params = "") {
      const incidentsURL =
        config.incidentsAPI + params + "&incidentoutputfields=all&locale=en";

      console.log(incidentsURL);

      //  Preparing the axios headers. Very impotant to note is the Authorization Header
      const axiosConfig = {
        headers: {
          "content-type": "application/json",
          Accept: "application/json",
          Authorization: "Bearer " + this.accessToken.token,
        },
      };

      // Executing a call using axios to get the Incidents data
      const incidentsResponse = await axios
        .get(incidentsURL, axiosConfig)
        .then((response) => {
          console.log(response.data);

          return response.data;
        })
        .catch((error) => {
          console.error(error);
        });

      return incidentsResponse;
    }
    // Creating Polygon latyer using the information from INRIX Incidents API and adding it to the map.
    async function drawIncidents() {
      document.getElementById("loading-panel").style.display = "block";

      // Access token management would be handled on the backend of your server, it would get / renew / reuse the token as necessary
      this.accessToken = await getToken();
      let params = "";
      const radius = await readCheckboxValues(
        document.querySelectorAll('input[name="radius"]:checked')
      );
      const boxInput = document.getElementById("box");

      let mustFill = true;
      if (boxInput.value || (radius && marker)) {
        mustFill = false;
      }

      if (mustFill) {
        alert(
          "please fill in the following: box, or radius & place marker on the map"
        );
        return;
      }

      // if there is point and radios
      if (radius) {
        params =
          "&radius=" +
          radius +
          "&pos=" +
          marker.position.lat() +
          "|" +
          marker.position.lng();
      }

      //  if there is a box
      if (boxInput.value) {
        params = "?box=" + boxInput.value;
      }

      const incidentType = await readCheckboxValues(
        document.querySelectorAll('input[name="incidentType"]:checked')
      );

      if (incidentType) {
        params += "&incidentType=" + incidentType;
      }

      // Getting the Drive Time Polygons as arrays of coordinates
      const incidentsData = await getIncidentsData(params);

      incidentsData.result.incidents.forEach((incident) => {
        const coords = {};
        [coords.lat, coords.lng] = incident.geometry.coordinates.map(Number);

        const marker = new google.maps.Marker({
          position: coords,
          map,
        });

        marker.addListener("click", () => {
          infowindow.open({
            anchor: marker,
            map,
            shouldFocus: false,
          });
        });

        const info = `${incident.descriptions[0].desc}`;
        const infowindow = new google.maps.InfoWindow({
          content: info,
        });
      });

      document.getElementById("loading-panel").style.display = "none";
    }
  </script>

  <script
    src="https://maps.googleapis.com/maps/api/js?v=weekly&libraries=geometry&callback=initMap&v=weekly"
    async
    defer
  ></script>
</html>
